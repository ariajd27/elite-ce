#include <stdlib.h>
#include <graphx.h>
#include "xorgfx.h"
#include "generation.h""

unsigned char txt_lineSpacing = 1;
unsigned char txt_cursorX = xor_clipX + 8;
unsigned char txt_cursorY = xor_clipY - 2;
enum { TXT_TITLECASE, TXT_UPPERCASE, TXT_LOWERCASE } txt_capsMode = TXT_UPPERCASE;
unsigned bool txt_capNext = false;

void txt_SetCursorPos(const unsigned char row, const unsigned char col)
{
	txt_cursorX = col * 8 + xor_clipX + 8;
	txt_cursorY = row * 8 + xor_clipY - 2;
}

void txt_PutC(const char c)
{
	unsigned char* charData = font_data + c * 8;

	for (unsigned char yy = 0; yy < 8; yy++)
	{
		for (unsigned char xx = 0; xx < 8; xx++)
		{
			if ((*charData & (0x80 >> xx)) == 0) continue;
			xor_PointNoClip(txt_cursorX + xx, txt_cursorY + yy);
		}

		charData++;
	}

	txt_cursorX += 8;
}

void txt_LF()
{
	txt_cursorY += 8 * txt_lineSpacing;
}

void txt_CRLF()
{
	txt_cursorX = xor_clipX + 8;
	txt_LF();
}

void txt_PutTok(const char c)
{
	if (c < 14)
	{
		switch(c)
		{
			case 0:
				txt_PutUInt32(player_money, 9, true);
				txt_PutRecursive(66); // " CR"
				txt_CRLF();
				return;

			case 1:
				txt_PutUInt32(gen_currentGalaxy, 3, false);
				return;

			case 2:
				gen_PrintName(currentSeed);
				return;

			case 3:
				gen_PrintName(selectedSeed);
				return;

			case 4:
				txt_PutString(cmdr_name);

			case 5:
				txt_PutRecursive(105); // "FUEL"
				txt_PutString(": ");
				txt_PutUInt32(player_fuel, 3, true);
				txt_PutRecursive(35); // " LIGHT YEARS"
				txt_CRLF();
				txt_PutRecursive(119); // "CASH: {player cash} CR[CRLF]"
				return;

			case 6: // enable sentence case
				txt_capsMode = TXT_SENTENCECASE;
				return;

			case 7:
				return;

			case 8: // enable all caps
				txt_capsMode = TXT_UPPERCASE;
				return;

			case 9: // go to column 21 and type ":"
				txt_cursorX = 21 * 8 + xor_clipX + 8;
				txt_PutC(':' - 32);
				return;

			case 11:
			case 12:
			case 13:
				txt_CRLF();
				return;

			case 10:
				txt_LF();
				return;
		}
	}
	else if (c < 32) // recursive tokens
	{
		txt_PutRecursive(c + 114);
	}
	else if (c < 65) // punctuation
	{
		txt_PutC(c - 32);
	}
	else if (c < 91) // letters
	{
		if (txt_capsMode == TXT_UPPERCASE || txt_capNext) txt_PutC(c - 32);
		else txt_PutC(c); // lowercase is c - 32 + 32
	}
	else if (c < 96) // more punctuation
	{
		txt_PutC(c - 32);
	}
	else if (c < 128) // more recursive tokens
	{
		txt_PutRecursive(c);
	}
	else if (c < 160) // twokens
	{
		txt_PutTok(twokens[c - 128][0]);
		txt_PutTok(twokens[c - 128][1]);
	}
	else // even more recursive tokens
	{
		txt_PutRecursive(c - 160);
	}
}

void txt_PutTokColon(const char c)
{
	txt_PutTok(c);
	txt_PutTok(':');
}

void txt_PutRecursive(char c)
{
	char *ptr = recursiveTokens;
	while (c > 0)
	{
		ptr++;
		if (*ptr == 0x00) c--;
	}
	txt_PutString(ptr);
}

void txt_PutString(char *c)
{
	do
	{
		txt_PutTok(*c ^ 35);
		c++;
	}
	while (*c != 0x00);
}

void txt_PutUInt32(unsigned long n, unsigned char width, bool tenths)
{
	width = 11 - width;
	unsigned char forcePrintTimer = tenths ? 10 : 11;

	for (unsigned int divisor = 10000000000; divisor >= 1; divisor /= 10)
	{
		if (divisor == 1 && tenths) txt_PutC('.' - 32);

		if (width == 0)
		{
			char nextChar = '0' + n / divisor;
			if (forcePrintTimer > 0)
			{
				if (nextChar == '0')
				{
					nextChar = ' ';
					forcePrintTimer--;
				}
				else forcePrintTimer = 0;
			}
		}
		else width--;

		xor_PrintChar(nextChar);
		n %= divisor;
	}
}










const char twokens[32][2] = {
	{ 'A', 'L' }, { 'L', 'E' }, { 'X', 'E' }, { 'G', 'E' }, 
	{ 'Z', 'A' }, { 'C', 'E' }, { 'B', 'I' }, { 'S', 'O' },
	{ 'U', 'S' }, { 'E', 'S' }, { 'A', 'R' }, { 'M', 'A' },
	{ 'I', 'N' }, { 'D', 'I' }, { 'R', 'E' }, { 'A', '?' },
	{ 'E', 'R' }, { 'A', 'T' }, { 'E', 'N' }, { 'B', 'E' },
	{ 'R', 'A' }, { 'L', 'A' }, { 'V', 'E' }, { 'T', 'I' },
	{ 'E', 'D' }, { 'O', 'R' }, { 'Q', 'U' }, { 'A', 'N' },
	{ 'T', 'E' }, { 'I', 'S' }, { 'R', 'I' }, { 'O', 'N' }
};

const unsigned char recursiveTokens[955] = {
  0x4c, 0x32, 0x24, 0x00, 0x03, 0x60, 0x6b, 0xa9, 0x77, 0x00, 0x64, 0x6c,
  0xb5, 0x71, 0x6d, 0x6e, 0xb1, 0x77, 0x00, 0x67, 0xb2, 0x62, 0x32, 0x20,
  0x00, 0xaf, 0xb5, 0x6d, 0x77, 0xba, 0x7a, 0x2f, 0x00, 0x70, 0x7a, 0x70,
  0xbf, 0x6e, 0x00, 0x73, 0xbd, 0xa6, 0x00, 0x21, 0x03, 0xa8, 0x71, 0x68,
  0x66, 0x77, 0x03, 0x85, 0x70, 0x00, 0xaf, 0x67, 0xab, 0x77, 0xbd, 0xa3,
  0x00, 0x62, 0x64, 0xbd, 0x60, 0x76, 0x6f, 0x77, 0x76, 0xb7, 0x6f, 0x00,
  0xbd, 0x60, 0x6b, 0x03, 0x00, 0x62, 0xb5, 0xb7, 0xa0, 0x03, 0x00, 0x73,
  0x6c, 0xba, 0x03, 0x00, 0xa8, 0xaf, 0x6f, 0x7a, 0x03, 0x00, 0x76, 0x6d,
  0x6a, 0x77, 0x00, 0x75, 0x6a, 0x66, 0x74, 0x03, 0x00, 0xb9, 0xb8, 0xb4,
  0x77, 0x7a, 0x00, 0xb8, 0xa9, 0x60, 0x6b, 0x7a, 0x00, 0x65, 0x66, 0x76,
  0x67, 0xa3, 0x00, 0x6e, 0x76, 0x6f, 0xb4, 0x0e, 0x81, 0x00, 0xae, 0x60,
  0x77, 0xb2, 0xba, 0x9a, 0x00, 0xd8, 0x6e, 0x76, 0x6d, 0xbe, 0x77, 0x00,
  0x60, 0xbc, 0x65, 0xbb, 0xb3, 0x62, 0x60, 0x7a, 0x00, 0x67, 0x66, 0x6e,
  0x6c, 0x60, 0xb7, 0x60, 0x7a, 0x00, 0x60, 0xba, 0x73, 0xba, 0xb2, 0x66,
  0x03, 0xe8, 0xb2, 0x66, 0x00, 0x70, 0x6b, 0x6a, 0x73, 0x00, 0x73, 0xdd,
  0x67, 0x76, 0x60, 0x77, 0x00, 0x03, 0xb6, 0x70, 0xb3, 0x00, 0x6b, 0x76,
  0x6e, 0xb8, 0x03, 0x60, 0x6c, 0x6f, 0xbc, 0x6a, 0xa3, 0x00, 0x6b, 0x7a,
  0x73, 0xb3, 0x70, 0x73, 0x62, 0xa6, 0x03, 0x00, 0x70, 0x6b, 0xba, 0x77,
  0x03, 0xe9, 0x82, 0x00, 0xae, 0xe8, 0xb8, 0xa6, 0x00, 0x73, 0x6c, 0x73,
  0x76, 0x6f, 0xb2, 0x6a, 0xbc, 0x00, 0x64, 0xdd, 0x70, 0x70, 0x03, 0x99,
  0x6a, 0x75, 0x6a, 0x77, 0x7a, 0x00, 0x66, 0x60, 0xbc, 0x6c, 0x6e, 0x7a,
  0x00, 0x03, 0x6f, 0x6a, 0x64, 0x6b, 0x77, 0x03, 0x7a, 0x66, 0xa9, 0x70,
  0x00, 0xbf, 0x60, 0x6b, 0x0d, 0xa2, 0xb5, 0x6f, 0x00, 0x60, 0x62, 0x70,
  0x6b, 0x00, 0x03, 0xa5, 0x2c, 0x6a, 0xbc, 0x00, 0x59, 0x82, 0x22, 0x00,
  0x77, 0xa9, 0xa0, 0x77, 0x03, 0x6f, 0x6c, 0xe8, 0x00, 0x49, 0x03, 0x69,
  0x62, 0x6e, 0x6e, 0xbb, 0x00, 0x71, 0xb8, 0xa0, 0x00, 0x70, 0x77, 0x00,
  0x93, 0x03, 0x6c, 0x65, 0x03, 0x00, 0x70, 0x66, 0x2c, 0x00, 0x03, 0x60,
  0xa9, 0x64, 0x6c, 0x25, 0x00, 0x66, 0xb9, 0x6a, 0x73, 0x00, 0x65, 0x6c,
  0x6c, 0x67, 0x00, 0xbf, 0x7b, 0xb4, 0x6f, 0xaa, 0x00, 0xb7, 0xae, 0x6c,
  0x62, 0x60, 0xb4, 0xb5, 0x70, 0x00, 0x70, 0xb6, 0xb5, 0x70, 0x00, 0x6f,
  0x6a, 0xb9, 0xba, 0x0c, 0x74, 0xaf, 0xaa, 0x00, 0x6f, 0x76, 0x7b, 0x76,
  0xbd, 0xaa, 0x00, 0x6d, 0xa9, 0x60, 0x6c, 0xb4, 0x60, 0x70, 0x00, 0xd8,
  0x73, 0x76, 0x77, 0xb3, 0x70, 0x00, 0xa8, 0x60, 0x6b, 0xaf, 0xb3, 0x7a,
  0x00, 0x62, 0x6f, 0x6f, 0x6c, 0x7a, 0x70, 0x00, 0x65, 0x6a, 0xad, 0xa9,
  0x6e, 0x70, 0x00, 0x65, 0x76, 0x71, 0x70, 0x00, 0x6e, 0xaf, 0xb3, 0xa3,
  0x70, 0x00, 0x64, 0x6c, 0x6f, 0x67, 0x00, 0x73, 0x6f, 0xb2, 0xaf, 0x76,
  0x6e, 0x00, 0xa0, 0x6e, 0x0e, 0xe8, 0xbc, 0xaa, 0x00, 0xa3, 0x6a, 0xb1,
  0x03, 0x5c, 0x70, 0x00, 0x2f, 0x12, 0x13, 0x23, 0x16, 0x23, 0x00, 0x03,
  0x60, 0x71, 0x00, 0x6f, 0xa9, 0xa0, 0x00, 0x65, 0x6a, 0xb3, 0xa6, 0x00,
  0x70, 0xa8, 0x2c, 0x00, 0x64, 0xad, 0xb1, 0x00, 0x71, 0xbb, 0x00, 0x7a,
  0x66, 0x2c, 0x6c, 0x74, 0x00, 0x61, 0x6f, 0x76, 0x66, 0x00, 0x61, 0xb6,
  0x60, 0x68, 0x00, 0x35, 0x00, 0x70, 0x6f, 0x6a, 0x6e, 0x7a, 0x00, 0x61,
  0x76, 0x64, 0x0e, 0x66, 0x7a, 0xbb, 0x00, 0x6b, 0xba, 0x6d, 0xbb, 0x00,
  0x61, 0xbc, 0x7a, 0x00, 0x65, 0xb2, 0x00, 0x65, 0x76, 0x71, 0x71, 0x7a,
  0x00, 0xdd, 0x67, 0xb1, 0x77, 0x00, 0x65, 0xdd, 0x64, 0x00, 0x6f, 0x6a,
  0xa7, 0x71, 0x67, 0x00, 0x6f, 0x6c, 0x61, 0xe8, 0xb3, 0x00, 0xa5, 0x71,
  0x67, 0x00, 0x6b, 0x76, 0x6e, 0xb8, 0x6c, 0x6a, 0x67, 0x00, 0x65, 0x66,
  0x6f, 0xaf, 0x66, 0x00, 0xaf, 0x70, 0x66, 0x60, 0x77, 0x00, 0x88, 0xb7,
  0xae, 0xab, 0x00, 0x60, 0x6c, 0x6e, 0x00, 0xd8, 0x6e, 0xb8, 0x67, 0xb3,
  0x00, 0x03, 0x67, 0xaa, 0x77, 0xdd, 0x7a, 0xbb, 0x00, 0x71, 0x6c, 0x00,
  0x8d, 0x03, 0x03, 0x93, 0x2f, 0x03, 0x99, 0x03, 0x03, 0x03, 0x8d, 0x03,
  0x85, 0x03, 0x65, 0xba, 0x03, 0x70, 0x62, 0xa2, 0x2f, 0x29, 0x00, 0x65,
  0x71, 0xbc, 0x77, 0x00, 0xad, 0xa9, 0x00, 0xa2, 0x65, 0x77, 0x00, 0xbd,
  0x64, 0x6b, 0x77, 0x00, 0x5a, 0x6f, 0x6c, 0x74, 0x24, 0x00, 0x40, 0x32,
  0xdf, 0x02, 0x00, 0x66, 0x7b, 0x77, 0xb7, 0x03, 0x00, 0x73, 0x76, 0x6f,
  0x70, 0x66, 0x98, 0x00, 0xb0, 0x62, 0x6e, 0x98, 0x00, 0x65, 0x76, 0x66,
  0x6f, 0x00, 0x6e, 0xbe, 0x70, 0x6a, 0xa2, 0x00, 0xc0, 0xed, 0x03, 0x61,
  0x62, 0x7a, 0x00, 0x66, 0x0d, 0x60, 0x0d, 0x6e, 0x0d, 0x86, 0x00, 0x45,
  0x44, 0x70, 0x00, 0x45, 0x4b, 0x70, 0x00, 0x4a, 0x03, 0x70, 0x60, 0x6c,
  0x6c, 0x73, 0x70, 0x00, 0xaa, 0x60, 0x62, 0x73, 0x66, 0x03, 0x73, 0x6c,
  0x67, 0x00, 0x5a, 0x61, 0x6c, 0x6e, 0x61, 0x00, 0x5a, 0x8d, 0x00, 0x67,
  0x6c, 0x60, 0x68, 0xaf, 0x64, 0x03, 0xf4, 0x00, 0x59, 0x03, 0x9e, 0x00,
  0x6e, 0x6a, 0x6f, 0x6a, 0x77, 0xa9, 0x7a, 0x03, 0x98, 0x00, 0x6e, 0xaf,
  0xaf, 0x64, 0x03, 0x98, 0x00, 0xe6, 0x19, 0x23, 0x00, 0xaf, 0xd8, 0xaf,
  0x64, 0x03, 0x49, 0x00, 0xb1, 0xb3, 0x64, 0x7a, 0x03, 0x00, 0x64, 0x62,
  0xb6, 0x60, 0xb4, 0x60, 0x00, 0x50, 0x03, 0x6c, 0x6d, 0x00, 0x62, 0x2c,
  0x00, 0x26, 0xa2, 0x64, 0xa3, 0x03, 0xe8, 0xb2, 0xab, 0x19, 0x00, 0xdf,
  0x03, 0x27, 0x2f, 0x2f, 0x2f, 0x25, 0x3c, 0x03, 0x86, 0x2a, 0x21, 0x2f,
  0x9e, 0x86, 0x2a, 0x20, 0x2f, 0x60, 0xbc, 0xae, 0xb4, 0xbc, 0x2a, 0x00,
  0x6a, 0xbf, 0x6e, 0x00, 0x00, 0x6f, 0x6f, 0x00, 0xb7, 0xb4, 0x6d, 0x64,
  0x19, 0x00, 0x03, 0xbc, 0x03, 0x00, 0x2f, 0x2b, 0xec, 0x6e, 0xb1, 0x77,
  0x19, 0x25, 0x00, 0x60, 0xa2, 0xb8, 0x00, 0x6c, 0x65, 0x65, 0xb1, 0x67,
  0xb3, 0x00, 0x65, 0x76, 0x64, 0x6a, 0xb4, 0xb5, 0x00, 0x6b, 0xa9, 0x6e,
  0xa2, 0x70, 0x70, 0x00, 0x6e, 0x6c, 0xe8, 0x6f, 0x7a, 0x03, 0x35, 0x00,
  0x8f, 0x00, 0x88, 0x00, 0x62, 0x61, 0x6c, 0xb5, 0x03, 0x88, 0x00, 0xd8,
  0x73, 0x66, 0x77, 0xb1, 0x77, 0x00, 0x67, 0xb8, 0xa0, 0xdd, 0xab, 0x00,
  0x67, 0x66, 0x62, 0x67, 0x6f, 0x7a, 0x00, 0x0e, 0x0e, 0x0e, 0x0e, 0x03,
  0x66, 0x03, 0x6f, 0x03, 0x6a, 0x03, 0x77, 0x03, 0x66, 0x03, 0x0e, 0x0e,
  0x0e, 0x0e, 0x00, 0x73, 0xad, 0x70, 0xb1, 0x77, 0x00, 0x2b, 0x64, 0x62,
  0x6e, 0x66, 0x03, 0x6c, 0xb5, 0x71, 0x00
};
